<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dire les vérités</title>

<style>
body {
  text-align: center;
  font-family: Arial;
  margin-top: 40px;
}

button, input[type="file"] {
  font-size: 18px;
  padding: 15px;
  margin: 10px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
}

button {
  color: white;
  width: 150px;
}

#affichage {
  width: 300px;
  height: 300px;
  margin: 20px auto;
  border: 3px solid #444;
  border-radius: 10px;
  background: white;
  background-size: cover;
  background-position: center;
}
</style>
</head>

<body>

<h1>Dire les vérités</h1>

<button style="background:red" data-color="red">Rouge</button>
<button style="background:orange" data-color="orange">Orange</button>
<button style="background:green" data-color="green">Vert</button>

<br>

<input type="file" id="imageInput" accept="image/*">

<div id="affichage"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===============================
   CONFIG SUPABASE
================================ */
const SUPABASE_URL = "https://ywwefbolidehfjnnvcih.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3d2VmYm9saWRlaGZqbm52Y2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTIxODgsImV4cCI6MjA4MTQ2ODE4OH0.UOsi15L0LTBCq0Hl_Qy9UhhUZ7_2F1MscMDiphDk2Mg";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===============================
   ELEMENTS
================================ */
const box = document.getElementById("affichage");
const imageInput = document.getElementById("imageInput");
const buttons = document.querySelectorAll("button");

/* ===============================
   FONCTIONS AFFICHAGE (LOCAL)
================================ */
function showColorLocal(color) {
  box.style.backgroundImage = "";
  box.style.backgroundColor = color;

  setTimeout(() => {
    box.style.backgroundColor = "white";
  }, 5000);
}

function showImageLocal(img) {
  box.style.backgroundColor = "white";
  box.style.backgroundImage = `url(${img})`;

  setTimeout(() => {
    box.style.backgroundImage = "";
  }, 5000);
}

/* ===============================
   CLIC COULEURS (LOCAL + ONLINE)
================================ */
buttons.forEach(btn => {
  btn.addEventListener("click", () => {
    const color = btn.dataset.color;

    // LOCAL (ça marche même sans internet)
    showColorLocal(color);

    // ONLINE (temps réel)
    if (channelSubscribed) {
      channel.send({
        type: "broadcast",
        event: "color",
        payload: { color }
      });
    }
  });
});

/* ===============================
   IMAGE (LOCAL + ONLINE)
================================ */
imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    showImageLocal(e.target.result);

    if (channelSubscribed) {
      channel.send({
        type: "broadcast",
        event: "image",
        payload: { image: e.target.result }
      });
    }
  };
  reader.readAsDataURL(file);
});

/* ===============================
   SUPABASE REALTIME
================================ */
let channelSubscribed = false;

const channel = supabase.channel("verites-live");

channel
  .on("broadcast", { event: "color" }, ({ payload }) => {
    showColorLocal(payload.color);
  })
  .on("broadcast", { event: "image" }, ({ payload }) => {
    showImageLocal(payload.image);
  });

channel.subscribe(status => {
  console.log("Realtime:", status);
  if (status === "SUBSCRIBED") {
    channelSubscribed = true;
  }
});
</script>

</body>
</html>
